<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a14">
    <title>–ì–ª–æ—Ç ‚Äî –ì–æ–ª–æ—Å–æ–≤–æ–π –¥—Ä—É–≥</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0a0a14;color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow:hidden}

        .debug-panel{background:#1a1a2e;padding:10px;font-size:11px;color:#888;border-bottom:1px solid #333;max-height:100px;overflow-y:auto}
        .debug-line{margin:2px 0;padding:2px 0;border-bottom:1px solid #2a2a3a}
        .debug-error{color:#f5576c}
        .debug-success{color:#4CAF50}
        .debug-warn{color:#FF9800}

        .header{padding:15px;text-align:center;background:linear-gradient(180deg,#1a1a2e 0%,#0a0a14 100%);position:relative}
        .avatar{width:80px;height:80px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:40px;transition:all 0.3s;box-shadow:0 0 25px rgba(102,126,234,0.4)}
        .avatar.error{background:linear-gradient(135deg,#f5576c 0%,#c0392b 100%);animation:none}
        .avatar.listening{animation:pulse 1s ease-in-out infinite;box-shadow:0 0 40px rgba(102,126,234,0.8)}
        .avatar.speaking{animation:speakPulse 0.5s ease-in-out infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        @keyframes speakPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}

        .status{font-size:11px;color:#667eea;text-transform:uppercase;letter-spacing:2px;margin-bottom:3px}
        .status.error{color:#f5576c}
        h1{font-size:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

        .chat{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
        .message{max-width:95%;padding:12px 16px;border-radius:18px;font-size:15px;line-height:1.6;animation:slideIn 0.3s ease;word-wrap:break-word}
        @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .message.glott{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);align-self:flex-start;border-bottom-left-radius:4px}
        .message.user{background:#2d2d44;align-self:flex-end;border-bottom-right-radius:4px}
        .message.error{background:#f5576c20;border:1px solid #f5576c;align-self:center;font-size:13px}
        .message .time{font-size:10px;opacity:0.6;margin-top:6px}

        .controls{padding:15px;background:#1a1a2e;border-top:1px solid #2d2d44}

        .voice-btn{width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;border-radius:12px;color:#fff;font-size:16px;margin-bottom:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
        .voice-btn:disabled{background:#333;color:#666;cursor:not-allowed}
        .voice-btn.active{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);animation:pulse 2s infinite}

        .input-area{display:flex;gap:10px;margin-bottom:10px}
        .text-input{flex:1;padding:12px;background:#2d2d44;border:none;border-radius:12px;color:#fff;font-size:15px}
        .send-btn{width:45px;height:45px;background:#667eea;border:none;border-radius:12px;color:#fff;font-size:18px;cursor:pointer}

        .hint{text-align:center;color:#888;font-size:13px;margin-top:10px}
        .hint.error{color:#f5576c}

        .settings-btn{position:fixed;top:15px;right:15px;width:40px;height:40px;background:#2d2d44;border:none;border-radius:10px;color:#fff;font-size:18px;cursor:pointer;z-index:100}
        .settings{position:fixed;top:0;right:-100%;width:85%;max-width:320px;height:100%;background:#1a1a2e;padding:70px 15px 15px;transition:right 0.3s;z-index:99;overflow-y:auto}
        .settings.open{right:0}
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);opacity:0;pointer-events:none;transition:opacity 0.3s;z-index:98}
        .overlay.open{opacity:1;pointer-events:auto}

        .setting-item{margin-bottom:15px}
        .setting-item label{display:block;margin-bottom:6px;color:#888;font-size:13px}
        .setting-item select,.setting-item input{width:100%;padding:10px;background:#2d2d44;border:none;border-radius:8px;color:#fff;font-size:14px}

        .test-btn{width:100%;padding:10px;background:#4CAF5020;color:#4CAF50;border:1px solid #4CAF50;border-radius:8px;margin-top:10px;cursor:pointer;font-size:13px}

        .wake-indicator{position:fixed;bottom:15px;left:15px;width:10px;height:10px;background:#333;border-radius:50%}
        .wake-indicator.active{background:#4CAF50;box-shadow:0 0 10px #4CAF50}
    </style>
</head>
<body>
    <div class="debug-panel" id="debugPanel">
        <div class="debug-line">üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
    <div class="overlay" onclick="toggleSettings()"></div>

    <div class="settings" id="settings">
        <div class="setting-item">
            <label>–ì–æ–ª–æ—Å–æ–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è</label>
            <select id="activationWord" onchange="saveSettings()">
                <option value="–≥–ª–æ—Ç">"–ì–ª–æ—Ç"</option>
                <option value="—ç–π">"–≠–π"</option>
                <option value="—Å–ª—ã—à—å">"–°–ª—ã—à—å"</option>
                <option value="none" selected>–ë–µ–∑ —Å–ª–æ–≤–∞ (—Å–ª—É—à–∞—Ç—å –≤—Å—ë)</option>
            </select>
        </div>
        <div class="setting-item">
            <label>–†–µ–∂–∏–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è</label>
            <select id="listenMode" onchange="saveSettings()">
                <option value="push">–ü–æ –∫–Ω–æ–ø–∫–µ (—ç–∫–æ–Ω–æ–º–∏—Ç –±–∞—Ç–∞—Ä–µ—é)</option>
                <option value="always">–ü–æ—Å—Ç–æ—è–Ω–Ω–æ (–≤—Å–µ–≥–¥–∞ —Å–ª—É—à–∞–µ—Ç)</option>
            </select>
        </div>
        <button class="test-btn" onclick="testVoice()">üé§ –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
        <button class="test-btn" onclick="testSpeech()">üîä –¢–µ—Å—Ç –æ–∑–≤—É—á–∫–∏</button>
    </div>

    <div class="header">
        <div class="avatar" id="avatar">üêô</div>
        <div class="status" id="status">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
        <h1>–ì–ª–æ—Ç</h1>
    </div>

    <div class="chat" id="chat"></div>

    <div class="controls">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">
            <span id="voiceIcon">üé§</span>
            <span id="voiceText">–ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏</span>
        </button>

        <div class="input-area">
            <input type="text" class="text-input" id="textInput" placeholder="–ò–ª–∏ –Ω–∞–ø–∏—à–∏ –∑–¥–µ—Å—å..." onkeypress="if(event.key==='Enter')sendText()">
            <button class="send-btn" onclick="sendText()">‚û§</button>
        </div>

        <div class="hint" id="hint">–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∫–æ–≥–¥–∞ –ø–æ–ø—Ä–æ—Å–∏—Ç</div>
    </div>

    <div class="wake-indicator" id="wakeIndicator"></div>

<script>
// === –î–ï–ë–ê–ì ===
function log(msg, type='info') {
    const panel = document.getElementById('debugPanel');
    const line = document.createElement('div');
    line.className = 'debug-line debug-' + type;
    line.textContent = new Date().toLocaleTimeString() + ' ' + msg;
    panel.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
    console.log('[' + type + ']', msg);
}

// === –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò ===
const support = {
    speechRecognition: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
    speechSynthesis: !!window.speechSynthesis,
    wakeLock: !!navigator.wakeLock,
    https: location.protocol === 'https:' || location.hostname === 'localhost'
};

log('HTTPS: ' + (support.https ? '–¥–∞' : '–Ω–µ—Ç'), support.https ? 'success' : 'warn');
log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏: ' + (support.speechRecognition ? '–¥–∞' : '–Ω–µ—Ç'), support.speechRecognition ? 'success' : 'error');
log('–û–∑–≤—É—á–∫–∞: ' + (support.speechSynthesis ? '–¥–∞' : '–Ω–µ—Ç'), support.speechSynthesis ? 'success' : 'error');

// === –°–û–°–¢–û–Ø–ù–ò–ï ===
let recognition = null;
let isListening = false;
let isSpeaking = false;
let config = {
    activationWord: localStorage.getItem('activationWord') || 'none',
    listenMode: localStorage.getItem('listenMode') || 'push'
};

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
function init() {
    updateUI();

    if (!support.speechRecognition) {
        showError('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –Ω–∞ Android –∏–ª–∏ Safari –Ω–∞ iOS');
        document.getElementById('voiceBtn').disabled = true;
        return;
    }

    if (!support.https) {
        showError('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–µ–±—É—é—Ç HTTPS. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ GitHub Pages, –∞ –Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ.');
    }

    initSpeech();

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—Å—Ç–æ–º (–µ—Å–ª–∏ –≥–æ–ª–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    setTimeout(() => {
        addMessage('–ü—Ä–∏–≤–µ—Ç! –Ø –ì–ª–æ—Ç. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É üé§ –∏ –≥–æ–≤–æ—Ä–∏. –ï—Å–ª–∏ –≥–æ–ª–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø–∏—à–∏ —Å—é–¥–∞!', false);
    }, 500);
}

function showError(msg) {
    log(msg, 'error');
    document.getElementById('status').textContent = '–æ—à–∏–±–∫–∞';
    document.getElementById('status').classList.add('error');
    document.getElementById('avatar').classList.add('error');
    document.getElementById('hint').textContent = msg;
    document.getElementById('hint').classList.add('error');

    const chat = document.getElementById('chat');
    const error = document.createElement('div');
    error.className = 'message error';
    error.textContent = '‚ö†Ô∏è ' + msg;
    chat.appendChild(error);
}

// === –ì–û–õ–û–°–û–í–û–ô –í–í–û–î ===
function initSpeech() {
    try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = () => {
            isListening = true;
            log('–ù–∞—á–∞–ª–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è', 'success');
            updateVoiceUI();
        };

        recognition.onend = () => {
            isListening = false;
            log('–ö–æ–Ω–µ—Ü –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è');
            updateVoiceUI();

            // –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –µ—Å–ª–∏ —Ä–µ–∂–∏–º "–≤—Å–µ–≥–¥–∞"
            if (config.listenMode === 'always') {
                setTimeout(() => recognition.start(), 500);
            }
        };

        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            log('–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ' + text, 'success');
            handleInput(text);
        };

        recognition.onerror = (e) => {
            log('–û—à–∏–±–∫–∞: ' + e.error, 'error');
            isListening = false;
            updateVoiceUI();

            if (e.error === 'not-allowed') {
                showError('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
            } else if (e.error === 'no-speech') {
                addMessage('–ù–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª... –ü–æ–≤—Ç–æ—Ä–∏?', false);
            }
        };

        log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        document.getElementById('status').textContent = '–≥–æ—Ç–æ–≤';

    } catch (e) {
        log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message, 'error');
        showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: ' + e.message);
    }
}

function toggleVoice() {
    if (!recognition) {
        showError('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ');
        return;
    }

    if (isListening) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

function updateVoiceUI() {
    const btn = document.getElementById('voiceBtn');
    const icon = document.getElementById('voiceIcon');
    const text = document.getElementById('voiceText');
    const avatar = document.getElementById('avatar');
    const status = document.getElementById('status');

    if (isListening) {
        btn.classList.add('active');
        icon.textContent = 'üëÇ';
        text.textContent = '–°–ª—É—à–∞—é...';
        avatar.classList.add('listening');
        status.textContent = '—Å–ª—É—à–∞—é';
    } else {
        btn.classList.remove('active');
        icon.textContent = 'üé§';
        text.textContent = config.listenMode === 'always' ? '–°–ª—É—à–∞—é –≤—Å–µ–≥–¥–∞' : '–ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏';
        avatar.classList.remove('listening');
        status.textContent = '–≥–æ—Ç–æ–≤';
    }
}

// === –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê ===
function handleInput(text) {
    addMessage(text, true);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞
    if (config.activationWord !== 'none') {
        if (!text.toLowerCase().includes(config.activationWord)) {
            log('–ê–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–ª–æ–≤–æ –Ω–µ detected');
            return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Å–ª–æ–≤–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        }
        log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Å–ª–æ–≤—É: ' + config.activationWord, 'success');
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
    setTimeout(() => {
        const response = generateResponse(text);
        speak(response);
    }, 300);
}

function generateResponse(text) {
    const lower = text.toLowerCase();

    if (lower.includes('–ø—Ä–∏–≤–µ—Ç')) return '–ü—Ä–∏–≤–µ—Ç! –°–ª—ã—à—É —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω–æ üëã';
    if (lower.includes('–∫–∞–∫ –¥–µ–ª–∞')) return '–†–∞–±–æ—Ç–∞—é! –ì–æ–ª–æ—Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç?';
    if (lower.includes('—Ç–µ—Å—Ç')) return '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –Ø —Å–ª—ã—à—É –∏ –≥–æ–≤–æ—Ä—é.';
    if (lower.includes('—Ä–∞–±–æ—Ç–∞–µ—à—å')) return '–î–∞! –ï—Å–ª–∏ —Ç—ã —ç—Ç–æ —Å–ª—ã—à–∏—à—å ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!';
    if (lower.includes('–ø–æ–∫–∞')) return '–ü–æ–∫–∞! –û–±—Ä–∞—â–∞–π—Å—è –≥–æ–ª–æ—Å–æ–º üòâ';

    return '–ü–æ–Ω—è–ª —Ç–µ–±—è! –ì–æ–ª–æ—Å–æ–≤–∞—è —Å–≤—è–∑—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.';
}

// === –û–ó–í–£–ß–ö–ê ===
function speak(text) {
    addMessage(text, false);

    if (!support.speechSynthesis) {
        log('–û–∑–≤—É—á–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
        return;
    }

    isSpeaking = true;
    document.getElementById('avatar').classList.add('speaking');
    document.getElementById('status').textContent = '–≥–æ–≤–æ—Ä–∏—Ç';

    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ru-RU';
    u.rate = 1;
    u.pitch = 1;

    u.onend = () => {
        isSpeaking = false;
        document.getElementById('avatar').classList.remove('speaking');
        document.getElementById('status').textContent = '–≥–æ—Ç–æ–≤';
    };

    u.onerror = (e) => {
        log('–û—à–∏–±–∫–∞ –æ–∑–≤—É—á–∫–∏: ' + e.error, 'error');
        isSpeaking = false;
    };

    speechSynthesis.speak(u);
    log('–ì–æ–≤–æ—Ä—é: ' + text);
}

// === –¢–ï–ö–°–¢–û–í–´–ô –í–í–û–î (–∑–∞–ø–∞—Å–Ω–æ–π) ===
function sendText() {
    const input = document.getElementById('textInput');
    const text = input.value.trim();
    if (text) {
        handleInput(text);
        input.value = '';
    }
}

// === UI ===
function addMessage(text, isUser) {
    const chat = document.getElementById('chat');
    const msg = document.createElement('div');
    msg.className = 'message ' + (isUser ? 'user' : 'glott');
    msg.textContent = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

// === –¢–ï–°–¢–´ ===
function testVoice() {
    log('–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...');
    if (!recognition) {
        showError('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        return;
    }

    recognition.start();
    setTimeout(() => {
        if (isListening) {
            addMessage('üé§ –¢–µ—Å—Ç: —Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...', false);
        }
    }, 500);
}

function testSpeech() {
    log('–¢–µ—Å—Ç –æ–∑–≤—É—á–∫–∏...');
    speak('–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –ï—Å–ª–∏ –≤—ã —Å–ª—ã—à–∏—Ç–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç, –æ–∑–≤—É—á–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.');
}

// === –ù–ê–°–¢–†–û–ô–ö–ò ===
function toggleSettings() {
    document.getElementById('settings').classList.toggle('open');
    document.querySelector('.overlay').classList.toggle('open');
}

function saveSettings() {
    config.activationWord = document.getElementById('activationWord').value;
    config.listenMode = document.getElementById('listenMode').value;
    localStorage.setItem('activationWord', config.activationWord);
    localStorage.setItem('listenMode', config.listenMode);
    updateUI();
}

function updateUI() {
    document.getElementById('activationWord').value = config.activationWord;
    document.getElementById('listenMode').value = config.listenMode;
    updateVoiceUI();
}

// === –°–¢–ê–†–¢ ===
window.onload = init;

// === –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö ===
window.onerror = (msg, url, line) => {
    log('JS Error: ' + msg + ' (line ' + line + ')', 'error');
};
</script>
</body>
</html>